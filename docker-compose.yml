version: "3.9"
services:
  api:
    build: .
    env_file: .env
    volumes:
      - ./vector_store:/app/vector_store
      - ./docs:/app/docs
    ports:
      - "8000:8000"
    depends_on:
      - redis
    # (unchanged CMD: uvicorn app.app:app ...)

  worker:
    build: .
    env_file: .env
    command: celery -A app.celery_app.celery_app worker --loglevel=INFO --concurrency=2
    volumes:
      - ./vector_store:/app/vector_store
      - ./docs:/app/docs
    depends_on:
      - redis

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  # Flower dashboard for Celery
  flower:
    image: mher/flower:2.0
    command: >
      celery --broker=${REDIS_URL:-redis://redis:6379/0}
      flower --port=5555
    environment:
      - CELERY_BROKER_URL=${REDIS_URL:-redis://redis:6379/0}
    ports:
      - "5555:5555"
    depends_on:
      - redis

  # Celery Prometheus exporter (reads from Redis)
  celery-exporter:
    image: danihodovic/celery-exporter:latest
    environment:
      - CELERY_BROKER_URL=${REDIS_URL:-redis://redis:6379/0}
    ports:
      - "9540:9540"
    depends_on:
      - redis

  # Prometheus server
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - api
      - celery-exporter
